<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kuiz Program BIG</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        body { user-select: none; -webkit-user-select: none; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans text-gray-800">

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbxGfuchGJDOrbsmE8psOuswEL0NK0Y0WcxITrcO040fCEck41zUqf2Rs8rG0M9kk6MI/exec";
    </script>

    <div id="loading" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
        <div class="bg-white p-5 rounded-lg flex flex-col items-center">
            <div class="loader mb-3"></div>
            <p class="font-bold text-gray-700">Memproses...</p>
        </div>
    </div>

    <div id="view-login" class="flex flex-col items-center justify-center min-h-screen p-4">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md">
            <div class="text-center mb-6">
                <h1 class="text-2xl font-bold text-blue-600">SISTEM KUIZ BIG</h1>
                <p class="text-gray-500 text-sm">Sila masukkan No. Kad Pengenalan</p>
            </div>
            <form onsubmit="handleLogin(event)">
                <input type="text" id="no_kp" class="w-full p-3 border rounded-lg mb-4 text-center tracking-widest text-lg font-bold" placeholder="Contoh: 010101010101" required>
                <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition">MULA KUIZ</button>
            </form>
        </div>
    </div>

    <div id="view-quiz" class="hidden min-h-screen p-4 pb-20 max-w-3xl mx-auto">
        <div class="bg-white p-4 rounded-lg shadow mb-4 sticky top-0 z-10 flex justify-between items-center">
            <div>
                <p class="text-xs text-gray-500">Nama Peserta</p>
                <p class="font-bold text-blue-700" id="display-name">-</p>
            </div>
            <div class="text-right">
                <p class="text-xs text-gray-500">Masa Tinggal</p>
                <p class="font-mono font-bold text-red-600 text-xl" id="timer">00:00</p>
            </div>
        </div>

        <div id="quiz-container" class="space-y-6"></div>

        <button onclick="submitQuiz()" class="w-full bg-green-600 text-white py-4 rounded-lg font-bold text-lg mt-8 shadow-lg hover:bg-green-700 transition">HANTAR JAWAPAN</button>
    </div>

    <script>
        let currentUser = null;
        let timerInterval;
        let answers = {};

        function showLoader(show) {
            document.getElementById('loading').classList.toggle('hidden', !show);
        }

        function handleLogin(e) {
            e.preventDefault();
            const kp = document.getElementById('no_kp').value.trim();
            if (!kp) return Swal.fire('Ralat', 'Sila masukkan No. KP', 'warning');

            showLoader(true);

            // Fetch Login
            fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'login', no_kp: kp })
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    currentUser = data;
                    loadQuestions();
                } else if (data.status === 'done') {
                    showLoader(false);
                    Swal.fire('Maaf', `Anda (${data.nama}) telah menjawab kuiz ini.`, 'info');
                } else {
                    showLoader(false);
                    Swal.fire('Gagal', 'No. KP tidak dijumpai dalam pangkalan data.', 'error');
                }
            })
            .catch(err => {
                showLoader(false);
                console.error(err);
                Swal.fire('Ralat Sambungan', 'Gagal menyambung ke server. Pastikan URL Script betul dan akses ditetapkan kepada "Anyone".', 'error');
            });
        }

        function loadQuestions() {
            fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'getQuestions' })
            })
            .then(res => res.json())
            .then(data => {
                showLoader(false);
                if (data.status === 'success') {
                    renderQuiz(data.data);
                    startTimer(currentUser.durasi || 30); // Default 30 minit
                    document.getElementById('view-login').classList.add('hidden');
                    document.getElementById('view-quiz').classList.remove('hidden');
                    document.getElementById('display-name').innerText = currentUser.nama;
                } else {
                    Swal.fire('Ralat', 'Tiada soalan ditemui.', 'error');
                }
            })
            .catch(err => {
                showLoader(false);
                Swal.fire('Ralat', 'Gagal memuat turun soalan.', 'error');
            });
        }

        function renderQuiz(questions) {
            const container = document.getElementById('quiz-container');
            container.innerHTML = '';

            questions.forEach((q, index) => {
                let optionsHTML = '';
                // Jika soalan objektif (A, B, C, D)
                if (q.options) {
                    for (const [key, val] of Object.entries(q.options)) {
                        if (val) { // Hanya paparkan jika ada isi
                            optionsHTML += `
                                <label class="flex items-start p-3 border rounded-lg cursor-pointer hover:bg-blue-50 transition mb-2">
                                    <input type="radio" name="q_${q.id}" value="${key}" class="mt-1 mr-3" onchange="saveAnswer('${q.id}', '${key}')">
                                    <span class="text-sm"><span class="font-bold mr-2">${key}.</span> ${val}</span>
                                </label>
                            `;
                        }
                    }
                }

                const html = `
                    <div class="bg-white p-5 rounded-lg shadow">
                        <p class="font-bold text-gray-800 mb-4"><span class="text-blue-600 mr-2">Soalan ${index + 1}:</span> ${q.soalan}</p>
                        <div class="space-y-2">
                            ${optionsHTML}
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        function saveAnswer(qid, ans) {
            answers[qid] = ans;
        }

        function startTimer(minutes) {
            let time = minutes * 60;
            const el = document.getElementById('timer');
            
            timerInterval = setInterval(() => {
                const m = Math.floor(time / 60);
                const s = time % 60;
                el.innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
                
                if (time <= 0) {
                    clearInterval(timerInterval);
                    Swal.fire({
                        title: 'Masa Tamat!',
                        text: 'Jawapan anda akan dihantar secara automatik.',
                        timer: 2000,
                        showConfirmButton: false
                    }).then(() => submitQuiz(true));
                }
                time--;
            }, 1000);
        }

        function submitQuiz(force = false) {
            if (!force) {
                // Kira soalan yang belum dijawab (Optional logic)
                // Terus tanya confirm
                Swal.fire({
                    title: 'Hantar Jawapan?',
                    text: "Pastikan anda telah menyemak semua jawapan.",
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Ya, Hantar!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        processSubmission();
                    }
                });
            } else {
                processSubmission();
            }
        }

        function processSubmission() {
            clearInterval(timerInterval);
            showLoader(true);

            const payload = {
                action: 'submit',
                no_kp: currentUser.no_kp || document.getElementById('no_kp').value, // Fallback
                nama: currentUser.nama,
                answers: answers
            };

            fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(data => {
                showLoader(false);
                Swal.fire({
                    title: 'Berjaya!',
                    text: 'Jawapan anda telah direkodkan.',
                    icon: 'success',
                    allowOutsideClick: false
                }).then(() => {
                    location.reload(); 
                });
            })
            .catch(err => {
                showLoader(false);
                Swal.fire('Ralat', 'Gagal menyimpan jawapan. Sila cuba lagi.', 'error');
            });
        }
    </script>
</body>
</html>
